<!DOCTYPE html>
<html lang="pl">
<head>
    <!-- Meta tagi dla SEO i bezpieczeństwa -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Barastion Dreamscape – Dziennik Snów, osobista podróż przez świat snów autora Barastion.">
    <meta name="title" content="Barastion Dreamscape – Dziennik Snów">
    <meta name="author" content="Barastion">
    <meta name="keywords" content="sny, dziennik snów, Barastion, blog, marzenia senne, twórczość">
    <meta name="robots" content="index, follow">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://*.firebaseio.com https://*.firebasedatabase.app; connect-src 'self' https://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebasedatabase.app; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data:; font-src 'self' https://fonts.gstatic.com;">
    <!-- Tytuł strony -->
    <title>Barastion Dreamscape – Dziennik Snów</title>
    <!-- Style i favicon -->
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="diabelek.png">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Status sieci -->
    <div id="networkStatus" class="network-status"></div>

    <!-- Główny kontener -->
    <div class="container">
        <!-- Nagłówek -->
        <header class="header">
            <!-- Ramka na logo -->
            <div class="logo-frame">
                <img src="Dreamscape_logo.jpg" alt="Barastion Dreamscape Logo" class="logo">
            </div>
            <!-- Tytuł w dwóch liniach -->
            <h1>Barastion Dreamscape<br>– Dziennik Snów</h1>
            <p class="header-subtitle">Osobista podróż przez świat snów autora Barastion</p>
        </header>

        <!-- Główna treść -->
        <main>
            <!-- Sekcja najnowszych postów -->
            <section class="posts-container">
                <h2>Najnowsze sny</h2>
                <p class="section-description">Przeczytaj trzy najnowsze wpisy z mojego dziennika snów</p>
                <div class="loading-spinner" id="postsLoading"></div>
                <div id="postsList" class="posts-list"></div>
            </section>

            <!-- Sekcja archiwum -->
            <section class="archive-container">
                <h2>Starsze sny</h2>
                <p class="section-description">Przeglądaj wszystkie moje sny w archiwum</p>
                <div class="loading-spinner" id="archiveLoading"></div>
                <div id="archiveList" class="archive-grid"></div>
            </section>
        </main>

        <!-- Stopka -->
        <footer class="footer">
            <p>© 2024 Barastion Dreamscape. Wszystkie prawa zastrzeżone.</p>
            <p class="footer-link">
                <a href="#" id="adminLink">Napisz nowy post – sekcja twórcy</a>
            </p>
            <p class="footer-link">
                <a href="terms.html" target="_blank">Regulamin</a>
            </p>
            <p class="footer-note">Stworzone z pasją przez Barastion</p>
        </footer>
    </div>

    <!-- Modal logowania -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h2>Sekcja twórcy</h2>
            <p>Zaloguj się, aby dodać nowy sen do dziennika.</p>
            <button id="googleLogin" class="btn btn-google">Zaloguj się przez Google</button>
            <p class="modal-note">Tylko autor (Barastion) może dodawać nowe posty.</p>
        </div>
    </div>

    <!-- Modal formularza nowego posta -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h2>Nowy sen</h2>
            <p>Wypełnij poniższy formularz, aby dodać nowy sen.</p>
            <form id="dreamForm" class="post-form">
                <div class="form-group">
                    <label for="postTitle">Tytuł posta:</label>
                    <input type="text" id="postTitle" required placeholder="np. Rozdział XXII">
                </div>
                <div class="form-group">
                    <label for="dreamDate">Data snu:</label>
                    <input type="text" id="dreamDate" required placeholder="np. 09.05.2025">
                </div>
                <div class="form-group">
                    <label for="postContent">Treść snu:</label>
                    <textarea id="postContent" required placeholder="Opisz swój sen..."></textarea>
                </div>
                <button type="submit" class="btn btn-submit">Zapisz sen</button>
            </form>
            <p class="modal-note">Twój sen zostanie zapisany w bazie danych.</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>

    <!-- JavaScript zaimplementowany w index.html -->
    <script>
        // Konfiguracja Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD5z_8jA3Yml6z2cECrAOkW2i5iT8UkbN0",
            authDomain: "dziennik-snow.firebaseapp.com",
            databaseURL: "https://dziennik-snow-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "dziennik-snow",
            storageBucket: "dziennik-snow.appspot.com",
            messagingSenderId: "1041128277683",
            appId: "1:1041128277683:web:8bdfa137c75e0c3bced7dd"
        };

        // Inicjalizacja Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // Elementy DOM
        const adminModal = document.getElementById('adminModal');
        const postModal = document.getElementById('postModal');
        const adminLink = document.getElementById('adminLink');
        const googleLogin = document.getElementById('googleLogin');
        const closes = document.querySelectorAll('.close');
        const networkStatus = document.getElementById('networkStatus');
        const postsList = document.getElementById('postsList');
        const archiveList = document.getElementById('archiveList');
        const dreamForm = document.getElementById('dreamForm');
        const postsLoading = document.getElementById('postsLoading');
        const archiveLoading = document.getElementById('archiveLoading');

        // Status sieci
        window.addEventListener('online', () => {
            networkStatus.classList.remove('offline');
            networkStatus.style.display = 'none';
        });
        window.addEventListener('offline', () => {
            networkStatus.classList.add('offline');
            networkStatus.style.display = 'block';
            networkStatus.textContent = 'Brak połączenia z internetem. Sprawdź połączenie.';
        });

        // Otwieranie modala logowania
        adminLink.addEventListener('click', (e) => {
            e.preventDefault();
            adminModal.style.display = 'block';
        });

        // Zamykanie modali
        closes.forEach(close => {
            close.addEventListener('click', () => {
                adminModal.style.display = 'none';
                postModal.style.display = 'none';
            });
        });

        // Logowanie przez Google
        googleLogin.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    if (result.user.email === 'lukasz13d@gmail.com') {
                        adminModal.style.display = 'none';
                        postModal.style.display = 'block';
                    } else {
                        alert('Dostęp tylko dla autora (lukasz13d@gmail.com).');
                        auth.signOut();
                    }
                })
                .catch((error) => {
                    console.error('Błąd logowania:', error.message);
                    alert('Błąd logowania: ' + error.message);
                });
        });

        // Wyświetlanie 3 najnowszych postów
        db.ref('posts').orderByChild('createdAt').limitToLast(3).on('value', (snapshot) => {
            postsList.innerHTML = '';
            postsLoading.classList.add('show');
            const posts = [];
            snapshot.forEach((child) => {
                posts.push({ id: child.key, ...child.val() });
            });
            if (posts.length === 0) {
                postsList.innerHTML = '<p class="no-posts">Brak postów do wyświetlenia.</p>';
            } else {
                posts.reverse().forEach((post) => {
                    const postDiv = document.createElement('div');
                    postDiv.className = 'post';
                    postDiv.innerHTML = `
                        <div class="post-meta">Opublikowano ${post.postDate} o ${post.postTime}</div>
                        <h3 class="post-title">${post.title}</h3>
                        <div class="post-data">${post.dreamDate}</div>
                        <div class="post-content">${post.content}</div>
                    `;
                    postsList.appendChild(postDiv);
                });
            }
            postsLoading.classList.remove('show');
        }, (error) => {
            console.error('Błąd ładowania postów:', error.message);
            alert('Błąd ładowania postów: ' + error.message);
        });

        // Wyświetlanie listy starszych postów
        db.ref('posts').orderByChild('createdAt').on('value', (snapshot) => {
            archiveList.innerHTML = '';
            archiveLoading.classList.add('show');
            snapshot.forEach((child) => {
                const post = child.val();
                const archiveItem = document.createElement('div');
                archiveItem.className = 'archive-item';
                archiveItem.textContent = post.title;
                archiveItem.addEventListener('click', () => {
                    postsList.innerHTML = `
                        <div class="post">
                            <div class="post-meta">Opublikowano ${post.postDate} o ${post.postTime}</div>
                            <h3 class="post-title">${post.title}</h3>
                            <div class="post-data">${post.dreamDate}</div>
                            <div class="post-content">${post.content}</div>
                        </div>
                    `;
                });
                archiveList.appendChild(archiveItem);
            });
            archiveLoading.classList.remove('show');
        }, (error) => {
            console.error('Błąd ładowania archiwum:', error.message);
            alert('Błąd ładowania archiwum: ' + error.message);
        });

        // Dodawanie nowego posta
        dreamForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const title = document.getElementById('postTitle').value;
            const dreamDate = document.getElementById('dreamDate').value;
            const content = document.getElementById('postContent').value;
            const now = new Date();
            const postDate = now.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const postTime = now.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });

            db.ref('posts').push({
                title,
                dreamDate,
                content,
                postDate,
                postTime,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            })
            .then(() => {
                alert('Sen zapisany pomyślnie!');
                dreamForm.reset();
                postModal.style.display = 'none';
            })
            .catch((error) => {
                console.error('Błąd zapisu posta:', error.message);
                alert('Błąd zapisu posta: ' + error.message);
            });
        });
    </script>
</body>
</html>
