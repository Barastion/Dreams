<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dziennik Snów - zapisuj i odkrywaj znaczenie swoich snów.">
    <meta name="keywords" content="dziennik snów, sny, marzenia senne, interpretacja snów">
    <meta name="author" content="Barastion">
    <title>Dziennik Snów</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="snow-icon.png">
</head>
<body>
    <div class="container">
        <div class="content-wrapper">
            <header class="header">
                <div class="logo-frame">
                    <img src="snow.jpg" alt="Dziennik Snów" class="logo">
                </div>
                <h1>Dziennik Snów</h1>
                <p class="header-subtitle">Twoje sny, twoje historie</p>
                <p class="header-subtitle">Zapisz i odkryj ich znaczenie</p>
            </header>

            <main>
                <!-- Sekcja wprowadzająca -->
                <section class="intro-container section-container">
                    <div class="section-box">
                        <h2>Witaj w Dzienniku Snów</h2>
                        <p class="intro-text">
                            To miejsce, w którym możesz zapisywać swoje sny, refleksje i odkrywać ich głębsze znaczenie.
                            Każdy sen to historia, a my pomagamy Ci ją opowiedzieć.
                            <span class="intro-toggle" id="introToggle">Rozwiń...</span>
                        </p>
                        <div class="intro-full" id="introFull">
                            <p>
                                Sny to okno do Twojej podświadomości. Niezależnie od tego, czy są one pełne magii, chaosu czy codziennych wydarzeń,
                                zasługują na to, by je zapisać. Dziennik Snów pozwala Ci nie tylko przechowywać te ulotne chwile,
                                ale także wracać do nich, analizować i znajdować w nich inspirację.
                            </p>
                            <p>
                                Zacznij już dziś – zapisz swój pierwszy sen i odkryj, co Twoje sny chcą Ci powiedzieć.
                            </p>
                        </div>
                    </div>
                </section>

                <!-- Sekcja postów -->
                <section class="posts-container section-container">
                    <div class="section-box">
                        <h2>Najnowsze sny</h2>
                        <div class="loading-spinner" id="postsLoading"></div>
                        <div class="posts-list" id="postsList"></div>
                    </div>
                </section>

                <!-- Sekcja archiwum -->
                <section class="archive-container section-container">
                    <div class="section-box">
                        <h2>Archiwum snów</h2>
                        <div class="loading-spinner" id="archiveLoading"></div>
                        <div class="archive-list" id="archiveList"></div>
                    </div>
                </section>
            </main>

            <!-- Modal logowania -->
            <div class="modal" id="adminModal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2>Zaloguj się</h2>
                    <p>Twój umysł zasługuje na chwilę refleksji...</p>
                    <button class="btn btn-google" id="googleLogin">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" width="20">
                        Zaloguj się przez Google
                    </button>
                    <p class="modal-note">Tylko autor może dodawać i edytować sny.</p>
                </div>
            </div>

            <!-- Modal dodawania/edycji posta -->
            <div class="modal large-modal" id="postModal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2 id="postModalTitle">Dodaj nowy sen</h2>
                    <form id="dreamForm" class="post-form">
                        <input type="hidden" id="postId">
                        <div class="form-group">
                            <label for="postTitle">Tytuł snu</label>
                            <input type="text" id="postTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="dreamDate">Data snu</label>
                            <input type="date" id="dreamDate" required>
                        </div>
                        <div class="form-group">
                            <label for="postContent">Opis snu</label>
                            <textarea id="postContent" required></textarea>
                        </div>
                        <div class="form-buttons">
                            <button type="button" class="btn btn-cancel" id="closeForm">Anuluj</button>
                            <button type="submit" class="btn btn-submit">Zapisz</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Status sieci -->
            <div class="network-status" id="networkStatus"></div>
        </div>
    </div>

    <footer class="footer">
        <p>© 2025 Barastion Dreamscape</p>
        <div class="footer-link">
            <span class="footer-text">Odwiedź:</span>
            <a href="https://lukas-baran.github.io/Barastion-Watchtower/" target="_blank">Barastion Watchtower</a>
            <a href="#" id="adminLink">Napisz nowy post</a>
            <a href="#" id="logoutLink" class="logout-link">Wyloguj</a>
        </div>
    </footer>

    <!-- Skrypt Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBdVZRNj5-ni4rqhlYoN7jJKd4lwMWZG-Q",
            authDomain: "dziennik-snow.firebaseapp.com",
            databaseURL: "https://dziennik-snow-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "dziennik-snow",
            storageBucket: "dziennik-snow.appspot.com",
            messagingSenderId: "1041128277683",
            appId: "1:1041128277683:web:8bdfa137c75e0c3bced7dd"
        };

        try {
            const app = initializeApp(firebaseConfig);
            console.log('Firebase zainicjalizowany.');
            const db = getDatabase(app);
            const auth = getAuth(app);

            // Elementy DOM
            const adminModal = document.getElementById('adminModal');
            const postModal = document.getElementById('postModal');
            const adminLink = document.getElementById('adminLink');
            const logoutLink = document.getElementById('logoutLink');
            const googleLogin = document.getElementById('googleLogin');
            const closes = document.querySelectorAll('.close');
            const networkStatus = document.getElementById('networkStatus');
            const postsList = document.getElementById('postsList');
            const archiveList = document.getElementById('archiveList');
            const dreamForm = document.getElementById('dreamForm');
            const postsLoading = document.getElementById('postsLoading');
            const archiveLoading = document.getElementById('archiveLoading');
            const closeForm = document.getElementById('closeForm');
            const postModalTitle = document.getElementById('postModalTitle');
            const postIdInput = document.getElementById('postId');
            const introToggle = document.getElementById('introToggle');
            const introFull = document.getElementById('introFull');

            // Sprawdzenie elementów
            if (!adminModal || !postModal || !adminLink || !logoutLink || !googleLogin || !closes.length || !networkStatus || !postsList || !archiveList || !dreamForm || !postsLoading || !archiveLoading || !closeForm || !postModalTitle || !postIdInput || !introToggle || !introFull) {
                console.error('Brak elementów DOM:', {
                    adminModal, postModal, adminLink, logoutLink, googleLogin, closes, networkStatus,
                    postsList, archiveList, dreamForm, postsLoading, archiveLoading, closeForm, postModalTitle, postIdInput, introToggle, introFull
                });
                networkStatus.textContent = 'Błąd: Brak elementów strony.';
                networkStatus.style.display = 'block';
                throw new Error('Brak elementów DOM');
            }

            // Zamykanie modalów przy ładowaniu strony
            document.addEventListener('DOMContentLoaded', () => {
                console.log('DOMContentLoaded: Zamykanie modalów');
                adminModal.style.display = 'none';
                postModal.style.display = 'none';
                logoutLink.style.display = 'none';
            });

            // Status sieci
            const updateNetworkStatus = () => {
                if (navigator.onLine) {
                    networkStatus.classList.remove('offline');
                    networkStatus.style.display = 'none';
                } else {
                    networkStatus.classList.add('offline');
                    networkStatus.textContent = 'Brak połączenia z internetem.';
                    networkStatus.style.display = 'block';
                }
            };
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
            updateNetworkStatus();

            // Funkcja otwierania formularza posta
            const openPostModal = (postId = null, postData = null) => {
                console.log('openPostModal wywołane:', { postId, postData, caller: new Error().stack }); // Debug
                postModalTitle.textContent = postId ? 'Edytuj sen' : 'Dodaj nowy sen';
                postIdInput.value = postId || '';
                document.getElementById('postTitle').value = postData?.title || '';
                document.getElementById('dreamDate').value = postData?.dreamDate || '';
                document.getElementById('postContent').value = postData?.content || '';
                postModal.style.display = 'block';
                adminModal.style.display = 'none';
                console.log(postId ? 'Otwarto formularz edycji.' : 'Otwarto formularz dodawania.');
            };

            // Otwieranie modala logowania lub formularza
            let isAuthenticated = false;
            adminLink.addEventListener('click', (e) => {
                e.preventDefault();
                console.log('Kliknięto adminLink:', { isAuthenticated }); // Debug
                if (isAuthenticated) {
                    openPostModal();
                } else {
                    adminModal.style.display = 'block';
                    postModal.style.display = 'none';
                    console.log('Otwarto modal logowania.');
                }
            });

            // Wylogowanie
            logoutLink.addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    await signOut(auth);
                    console.log('Wylogowano pomyślnie.');
                    isAuthenticated = false;
                    adminLink.textContent = 'Napisz nowy post';
                    logoutLink.style.display = 'none';
                    adminModal.style.display = 'none';
                    postModal.style.display = 'none';
                    alert('Wylogowano pomyślnie.');
                } catch (error) {
                    console.error('Błąd wylogowania:', error);
                    alert(`Błąd wylogowania: ${error.message}`);
                    networkStatus.textContent = 'Błąd wylogowania. Sprawdź konsolę.';
                    networkStatus.style.display = 'block';
                }
            });

            // Zamykanie modalów
            closes.forEach(close => {
                close.addEventListener('click', () => {
                    adminModal.style.display = 'none';
                    postModal.style.display = 'none';
                    dreamForm.reset();
                    postIdInput.value = '';
                    postModalTitle.textContent = 'Dodaj nowy sen';
                    console.log('Zamknięto modal.');
                });
            });

            closeForm.addEventListener('click', () => {
                adminModal.style.display = 'none';
                postModal.style.display = 'none';
                dreamForm.reset();
                postIdInput.value = '';
                postModalTitle.textContent = 'Dodaj nowy sen';
                console.log('Zamknięto formularz.');
            });

            // Logowanie Google
            googleLogin.addEventListener('click', async () => {
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                try {
                    console.log('Próba logowania Google...');
                    const result = await signInWithPopup(auth, provider);
                    console.log('Logowanie udane:', result.user.email);
                    if (result.user.email === 'lukasz13d@gmail.com') {
                        isAuthenticated = true;
                        adminModal.style.display = 'none';
                        postModal.style.display = 'none'; // Zapewniamy zamknięcie po zalogowaniu
                        console.log('Zalogowano autora, postModal zamknięty.');
                    } else {
                        alert('Dostęp tylko dla autora.');
                        await signOut(auth);
                        console.log('Wylogowano nieautoryzowanego użytkownika.');
                    }
                } catch (error) {
                    console.error('Błąd logowania:', error);
                    alert(`Błąd logowania: ${error.message} (Kod: ${error.code})`);
                    if (error.code === 'auth/popup-blocked') {
                        alert('Popup zablokowany. Włącz wyskakujące okna dla tej strony.');
                    }
                    networkStatus.textContent = 'Błąd logowania. Sprawdź konsolę.';
                    networkStatus.style.display = 'block';
                }
            });

            // Obsługa stanu autoryzacji
            onAuthStateChanged(auth, (user) => {
                console.log('onAuthStateChanged wywołane:', { user: user?.email }); // Debug
                if (user && user.email === 'lukasz13d@gmail.com') {
                    console.log('Zalogowano:', user.email);
                    isAuthenticated = true;
                    adminLink.textContent = 'Dodaj nowy post';
                    logoutLink.style.display = 'inline';
                    adminModal.style.display = 'none';
                    postModal.style.display = 'none'; // Zapewniamy zamknięcie
                } else {
                    console.log('Brak zalogowanego użytkownika lub nieprawidłowy email.');
                    isAuthenticated = false;
                    adminLink.textContent = 'Napisz nowy post';
                    logoutLink.style.display = 'none';
                    adminModal.style.display = 'none';
                    postModal.style.display = 'none'; // Zapewniamy zamknięcie
                }
            });

            // Rozwijanie sekcji wprowadzającej
            introToggle.addEventListener('click', () => {
                if (introFull.style.display === 'block') {
                    introFull.style.display = 'none';
                    introToggle.textContent = 'Rozwiń...';
                } else {
                    introFull.style.display = 'block';
                    introToggle.textContent = 'Zwiń';
                }
            });

            // Ładowanie postów
            const loadPosts = () => {
                postsLoading.classList.add('show');
                const postsRef = ref(db, 'posts');
                onValue(postsRef, (snapshot) => {
                    postsList.innerHTML = '';
                    const posts = [];
                    snapshot.forEach((childSnapshot) => {
                        const post = childSnapshot.val();
                        post.id = childSnapshot.key;
                        posts.push(post);
                    });
                    if (posts.length === 0) {
                        postsList.innerHTML = '<p class="no-posts">Brak snów do wyświetlenia.</p>';
                    } else {
                        posts.sort((a, b) => b.createdAt - a.createdAt);
                        const latestPosts = posts.slice(0, 3);
                        latestPosts.forEach((post) => {
                            const postElement = document.createElement('div');
                            postElement.className = 'post';
                            postElement.innerHTML = `
                                <p class="post-meta">Data snu: ${post.dreamDate}</p>
                                <h3 class="post-title">${post.title}</h3>
                                <p class="post-data">Dodano: ${new Date(post.createdAt).toLocaleDateString('pl-PL')}</p>
                                <p class="post-content">${post.content.substring(0, 200)}${post.content.length > 200 ? '...' : ''}</p>
                                ${isAuthenticated ? `<button class="btn btn-edit" data-id="${post.id}">Edytuj</button>` : ''}
                            `;
                            postsList.appendChild(postElement);
                        });
                        const editButtons = document.querySelectorAll('.btn-edit');
                        editButtons.forEach(button => {
                            button.addEventListener('click', () => {
                                const postId = button.getAttribute('data-id');
                                const post = posts.find(p => p.id === postId);
                                openPostModal(postId, post);
                            });
                        });
                    }
                    postsLoading.classList.remove('show');
                }, (error) => {
                    console.error('Błąd ładowania postów:', error);
                    postsList.innerHTML = '<p class="no-posts">Błąd ładowania snów.</p>';
                    networkStatus.textContent = 'Błąd ładowania snów. Sprawdź konsolę.';
                    networkStatus.style.display = 'block';
                    postsLoading.classList.remove('show');
                });
            };

            // Ładowanie archiwum
            const loadArchive = () => {
                archiveLoading.classList.add('show');
                const postsRef = ref(db, 'posts');
                onValue(postsRef, (snapshot) => {
                    archiveList.innerHTML = '';
                    const posts = [];
                    snapshot.forEach((childSnapshot) => {
                        const post = childSnapshot.val();
                        post.id = childSnapshot.key;
                        posts.push(post);
                    });
                    if (posts.length === 0) {
                        archiveList.innerHTML = '<p class="no-posts">Brak snów w archiwum.</p>';
                    } else {
                        const months = {};
                        posts.forEach(post => {
                            const date = new Date(post.createdAt);
                            const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                            if (!months[monthYear]) {
                                months[monthYear] = [];
                            }
                            months[monthYear].push(post);
                        });
                        Object.keys(months).sort().reverse().forEach(monthYear => {
                            const [year, month] = monthYear.split('-');
                            const monthName = new Date(year, month - 1).toLocaleString('pl-PL', { month: 'long', year: 'numeric' });
                            const archiveItem = document.createElement('div');
                            archiveItem.className = 'archive-item';
                            archiveItem.innerHTML = `
                                <span>${monthName}</span>
                                <span class="expand-arrow">▼</span>
                            `;
                            archiveList.appendChild(archiveItem);
                            const postList = document.createElement('div');
                            postList.className = 'archive-posts';
                            postList.style.display = 'none';
                            months[monthYear].sort((a, b) => b.createdAt - a.createdAt).forEach(post => {
                                const postElement = document.createElement('div');
                                postElement.className = 'post';
                                postElement.innerHTML = `
                                    <p class="post-meta">Data snu: ${post.dreamDate}</p>
                                    <h3 class="post-title">${post.title}</h3>
                                    <p class="post-data">Dodano: ${new Date(post.createdAt).toLocaleDateString('pl-PL')}</p>
                                    <p class="post-content">${post.content}</p>
                                    ${isAuthenticated ? `<button class="btn btn-edit" data-id="${post.id}">Edytuj</button>` : ''}
                                `;
                                postList.appendChild(postElement);
                            });
                            archiveList.appendChild(postList);
                            archiveItem.addEventListener('click', () => {
                                const arrow = archiveItem.querySelector('.expand-arrow');
                                if (postList.style.display === 'none') {
                                    postList.style.display = 'block';
                                    arrow.textContent = '▲';
                                } else {
                                    postList.style.display = 'none';
                                    arrow.textContent = '▼';
                                }
                            });
                            const editButtons = postList.querySelectorAll('.btn-edit');
                            editButtons.forEach(button => {
                                button.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    const postId = button.getAttribute('data-id');
                                    const post = months[monthYear].find(p => p.id === postId);
                                    openPostModal(postId, post);
                                });
                            });
                        });
                    }
                    archiveLoading.classList.remove('show');
                }, (error) => {
                    console.error('Błąd ładowania archiwum:', error);
                    archiveList.innerHTML = '<p class="no-posts">Błąd ładowania archiwum.</p>';
                    networkStatus.textContent = 'Błąd ładowania archiwum. Sprawdź konsolę.';
                    networkStatus.style.display = 'block';
                    archiveLoading.classList.remove('show');
                });
            };

            // Zapis posta
            dreamForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!isAuthenticated) {
                    alert('Musisz być zalogowanym autorem.');
                    return;
                }
                const postId = postIdInput.value;
                const title = document.getElementById('postTitle').value.trim();
                const dreamDate = document.getElementById('dreamDate').value;
                const content = document.getElementById('postContent').value.trim();
                if (!title || !dreamDate || !content) {
                    alert('Wypełnij wszystkie pola.');
                    return;
                }
                try {
                    const postData = {
                        title,
                        dreamDate,
                        content,
                        createdAt: serverTimestamp()
                    };
                    if (postId) {
                        await set(ref(db, `posts/${postId}`), postData);
                        console.log('Post edytowany:', postId);
                    } else {
                        await push(ref(db, 'posts'), postData);
                        console.log('Post dodany.');
                    }
                    dreamForm.reset();
                    postIdInput.value = '';
                    postModal.style.display = 'none';
                    postModalTitle.textContent = 'Dodaj nowy sen';
                    alert(postId ? 'Sen zaktualizowany.' : 'Sen dodany.');
                } catch (error) {
                    console.error('Błąd zapisu posta:', error);
                    alert(`Błąd zapisu: ${error.message}`);
                    networkStatus.textContent = 'Błąd zapisu posta. Sprawdź konsolę.';
                    networkStatus.style.display = 'block';
                }
            });

            // Inicjalizacja
            loadPosts();
            loadArchive();
        } catch (error) {
            console.error('Błąd inicjalizacji Firebase:', error);
            const networkStatus = document.getElementById('networkStatus');
            if (networkStatus) {
                networkStatus.textContent = 'Krytyczny błąd Firebase. Sprawdź konsolę.';
                networkStatus.style.display = 'block';
            }
        }
    </script>
</body>
</html>
