<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Barastion Dreamscape - Dziennik Snów. Wyjątkowe opowieści ze świata snów.">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' https://www.gstatic.com https://*.firebaseio.com; connect-src 'self' https://*.firebaseio.com wss://*.firebaseio.com">
    <title>Barastion Dreamscape - Dziennik Snów</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
</head>
<body>
    <div class="container">
        <div class="image-frame">
            <img src="https://firebasestorage.googleapis.com/v0/b/dziennik-snow.appspot.com/o/Dreamscape_logo.jpg?alt=media" alt="Barastion Dreamscape">
        </div>
        <header>
            <h1>Barastion Dreamscape<br>- Dziennik Snów</h1>
        </header>
        <main>
            <section id="latest-posts">
                <h2>Najnowsze wpisy</h2>
                <div id="posts-container"></div>
            </section>
            <section id="archive">
                <h2>Archiwum</h2>
                <ul id="archive-list"></ul>
                <div id="archive-post"></div>
            </section>
        </main>
        <footer>
            <p>© 2024 Barastion Dreamscape. Wszystkie prawa zastrzeżone.</p>
            <p><a href="#" id="admin-login">Napisz nowy post - sekcja twórcy</a></p>
        </footer>
    </div>

    <!-- Formularz logowania admina -->
    <div id="admin-login-form" style="display: none;">
        <div class="auth-container">
            <h2>Logowanie admina</h2>
            <form id="admin-form">
                <input type="password" id="admin-password" placeholder="Hasło" required>
                <button type="submit">Zaloguj się</button>
            </form>
        </div>
    </div>

    <!-- Formularz dodawania wpisu -->
    <div id="admin-post-form" style="display: none;">
        <div class="auth-container">
            <h2>Dodaj nowy wpis</h2>
            <form id="post-form">
                <input type="text" id="post-title" placeholder="Tytuł (np. Rozdział XXII)" required>
                <input type="date" id="dream-date" required>
                <textarea id="post-content" placeholder="Treść snu" required></textarea>
                <button type="submit">Opublikuj</button>
            </form>
        </div>
    </div>

    <!-- Formularz komentarza -->
    <div id="comment-form" style="display: none;">
        <div class="auth-container">
            <h2>Napisz komentarz</h2>
            <form id="comment-submit-form">
                <input type="text" id="comment-nick" placeholder="Nick (3-15 znaków)" required>
                <textarea id="comment-content" placeholder="Treść (3-500 znaków)" required></textarea>
                <button type="submit">Dodaj komentarz</button>
            </form>
        </div>
    </div>

    <script>
        // Konfiguracja Firebase (wstaw swoje dane z konsoli Firebase)
        const firebaseConfig = {
            apiKey: "TWOJ_API_KEY",
            authDomain: "dziennik-snow.firebaseapp.com",
            projectId: "dziennik-snow",
            storageBucket: "dziennik-snow.appspot.com",
            messagingSenderId: "TWOJ_MESSAGING_SENDER_ID",
            appId: "TWOJ_APP_ID"
        };

        // Inicjalizacja Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Funkcja formatująca datę z YYYY-MM-DD na DD.MM.YYYY
        function formatDate(dateStr) {
            const [year, month, day] = dateStr.split('-');
            return `${day}.${month}.${year}`;
        }

        // Ładowanie 3 najnowszych wpisów
        function loadLatestPosts() {
            db.collection('posts').orderBy('createdAt', 'desc').limit(3).get().then(snapshot => {
                const postsContainer = document.getElementById('posts-container');
                postsContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    const post = doc.data();
                    const formattedDreamDate = formatDate(post.dreamDate);
                    postsContainer.innerHTML += `
                        <div class="post">
                            <p class="post-date">Opublikowano ${post.postDate} o ${post.postTime}</p>
                            <h3>${post.title}</h3>
                            <p><strong>Data:</strong> ${formattedDreamDate}</p>
                            <p><strong>Treść:</strong> ${post.content}</p>
                            <div class="comments-section">
                                <p>Liczba komentarzy: <span id="comment-count-${doc.id}">0</span> | <a href="#" class="write-comment" data-post-id="${doc.id}">Napisz komentarz</a></p>
                            </div>
                        </div>
                    `;
                    db.collection('comments').where('postId', '==', doc.id).get().then(commentSnapshot => {
                        document.getElementById(`comment-count-${doc.id}`).textContent = commentSnapshot.size;
                    });
                });

                // Obsługa "Napisz komentarz"
                document.querySelectorAll('.write-comment').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const postId = e.target.getAttribute('data-post-id');
                        document.getElementById('comment-form').style.display = 'block';
                        document.getElementById('comment-submit-form').onsubmit = async (e) => {
                            e.preventDefault();
                            const nick = document.getElementById('comment-nick').value;
                            const content = document.getElementById('comment-content').value;
                            if (nick.length < 3 || nick.length > 15) {
                                alert(nick.length < 3 ? 'Za krótki nick' : 'Za długi nick');
                                return;
                            }
                            if (content.length < 3 || content.length > 500) {
                                alert(content.length < 3 ? 'Za krótka treść' : 'Za długa treść');
                                return;
                            }
                            await db.collection('comments').add({
                                postId,
                                nick,
                                content,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            document.getElementById('comment-form').style.display = 'none';
                            loadLatestPosts();
                        };
                    });
                });
            });
        }

        // Ładowanie archiwum
        function loadArchive() {
            db.collection('posts').orderBy('createdAt', 'desc').get().then(snapshot => {
                const archiveList = document.getElementById('archive-list');
                archiveList.innerHTML = '';
                snapshot.forEach(doc => {
                    const post = doc.data();
                    archiveList.innerHTML += `<li><a href="#" class="archive-link" data-post-id="${doc.id}">${post.title}</a></li>`;
                });

                document.querySelectorAll('.archive-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const postId = e.target.getAttribute('data-post-id');
                        db.collection('posts').doc(postId).get().then(doc => {
                            const post = doc.data();
                            const formattedDreamDate = formatDate(post.dreamDate);
                            document.getElementById('archive-post').innerHTML = `
                                <div class="post">
                                    <p class="post-date">Opublikowano ${post.postDate} o ${post.postTime}</p>
                                    <h3>${post.title}</h3>
                                    <p><strong>Data:</strong> ${formattedDreamDate}</p>
                                    <p><strong>Treść:</strong> ${post.content}</p>
                                </div>
                            `;
                        });
                    });
                });
            });
        }

        // Logowanie admina
        document.getElementById('admin-login').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('admin-login-form').style.display = 'block';
        });

        document.getElementById('admin-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('admin-password').value;
            try {
                await auth.signInWithEmailAndPassword('barastion@example.com', password);
                document.getElementById('admin-login-form').style.display = 'none';
                document.getElementById('admin-post-form').style.display = 'block';
            } catch (error) {
                alert('Błędne hasło');
            }
        });

        // Dodawanie nowego wpisu
        document.getElementById('post-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('post-title').value;
            const dreamDate = document.getElementById('dream-date').value;
            const content = document.getElementById('post-content').value;
            const postDate = new Date().toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const postTime = new Date().toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });

            try {
                await db.collection('posts').add({
                    title,
                    dreamDate,
                    content,
                    postDate,
                    postTime,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('Wpis dodano pomyślnie!');
                document.getElementById('admin-post-form').style.display = 'none';
                loadLatestPosts();
                loadArchive();
            } catch (error) {
                alert('Błąd: ' + error.message);
            }
        });

        // Inicjalizacja strony
        loadLatestPosts();
        loadArchive();
    </script>
</body>
</html>
