<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Barastion Dreamscape – Dziennik Snów. Osobista podróż przez świat snów.">
    <meta name="keywords" content="dziennik snów, Barastion Dreamscape, interpretacja snów, świadome śnienie, zapisywanie snów">
    <meta name="author" content="Łukasz Baran">
    <meta property="og:title" content="Barastion Dreamscape – Dziennik Snów">
    <meta property="og:description" content="Osobista podróż przez świat snów. Zapisz i odkryj znaczenie swoich snów.">
    <meta property="og:image" content="Dreamscape_logo.jpg">
    <meta property="og:url" content="https://lukas-baran.github.io/Dziennik-Snow/">
    <meta property="og:type" content="website">
    <title>Barastion Dreamscape – Dziennik Snów</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/jpg" href="Dreamscape_logo.jpg">
</head>
<body>
    <div class="container">
        <div class="content-wrapper">
            <header class="header">
                <div class="logo-frame">
                    <img src="Dreamscape_logo.jpg" alt="Barastion Dreamscape Logo" class="logo">
                </div>
                <h1>Barastion Dreamscape</h1>
                <p class="header-subtitle">– Dziennik Snów</p>
                <p class="header-subtitle">Osobista podróż przez świat snów</p>
            </header>

            <main>
                <!-- Sekcja wprowadzająca -->
                <div class="section-container">
                    <section class="intro-container section-box">
                        <h2>Słowem wstępu</h2>
                        <p class="intro-text">
                            Witaj w Barastion Dreamscape – moim osobistym dzienniku snów, w którym zapisuję i zgłębiam świat marzeń sennych. 
                            Każdy sen to unikalna opowieść, a ja staram się je zrozumieć i odkryć ich znaczenie.
                            <span id="expandIntro" class="intro-toggle">Rozwiń wstęp</span>
                        </p>
                        <div id="introFull" class="intro-full">
                            <p>
                                Śnienie to fascynujący proces, który pozwala nam zajrzeć w głąb naszej podświadomości. 
                                W tym dzienniku znajdziesz moje sny – od tych codziennych po świadome, pełne symboli i emocji. 
                                Moim celem jest nie tylko zapisanie ich, ale także analiza i poszukiwanie wzorców, które mogą rzucić światło na moje wnętrze. 
                                Jeśli interesuje Cię świat snów, zapraszam do lektury i wspólnego odkrywania ich tajemnic. 
                                <span id="collapseIntro" class="intro-toggle">Zwiń wstęp</span>
                            </p>
                        </div>
                    </section>
                </div>

                <!-- Sekcja postów -->
                <div class="section-container">
                    <section class="posts-container section-box">
                        <h2>Najnowsze wpisy</h2>
                        <div id="postsLoading" class="loading-spinner"></div>
                        <div id="postsList" class="posts-list"></div>
                    </section>
                </div>

                <!-- Sekcja archiwum -->
                <div class="section-container">
                    <section class="archive-container section-box">
                        <h2>Archiwum</h2>
                        <div id="archiveLoading" class="loading-spinner"></div>
                        <div id="archiveList" class="archive-list"></div>
                    </section>
                </div>

                <!-- Link do sekcji tworzenia postów -->
                <div class="section-container">
                    <section class="section-box">
                        <p class="footer-link"><a href="#" id="adminLink">Napisz nowy post – sekcja twórcy</a></p>
                    </section>
                </div>
            </main>

            <footer class="footer">
                <p>&copy; 2025 Barastion Dreamscape. Wszelkie prawa zastrzeżone.</p>
                <p class="footer-link"><a href="https://lukas-baran.github.io/Barastion-Watchtower/" target="_blank">Odwiedź Barastion Watchtower</a></p>
            </footer>
        </div>
    </div>

    <!-- Modal logowania -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Zaloguj się</h2>
            <p>Zaloguj się, aby dodać nowy post. Dostęp tylko dla autora.</p>
            <button id="googleLogin" class="btn btn-google">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8c2.12 0 4.07.83 5.51 2.19l-2.09 2.09C14.64 6.49 13.38 6 12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.81 0 5.19-1.94 5.83-4.7h-5.83v-2.83h8.66c.07.41.11.84.11 1.28 0 4.41-3.59 8-8 8z"/>
                </svg>
                Zaloguj się przez Google
            </button>
            <p class="modal-note">Tylko konto lukasz13d@gmail.com ma dostęp do edycji.</p>
        </div>
    </div>

    <!-- Modal dodawania posta -->
    <div id="postModal" class="modal">
        <div class="modal-content large-modal">
            <span class="close">&times;</span>
            <h2>Dodaj nowy sen</h2>
            <form id="dreamForm" class="post-form">
                <div class="form-group">
                    <label for="postTitle">Tytuł snu</label>
                    <input type="text" id="postTitle" name="postTitle" placeholder="Np. Lot nad oceanem" required>
                </div>
                <div class="form-group">
                    <label for="dreamDate">Data snu</label>
                    <input type="date" id="dreamDate" name="dreamDate" required>
                </div>
                <div class="form-group">
                    <label for="postContent">Opis snu</label>
                    <textarea id="postContent" name="postContent" placeholder="Opisz swój sen szczegółowo..." required></textarea>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="btn btn-submit">Zapisz sen</button>
                    <button type="button" id="closeForm" class="btn btn-cancel">Zamknij</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Status sieci -->
    <div id="networkStatus" class="network-status"></div>

    <!-- Skrypty -->
    <script type="module">
        // Obsługa błędów globalnych
        window.addEventListener('error', (event) => {
            console.error('Błąd globalny:', event);
            const networkStatus = document.getElementById('networkStatus');
            if (event.message.includes('firebase')) {
                networkStatus.textContent = 'Błąd ładowania Firebase SDK. Sprawdź połączenie.';
                networkStatus.style.display = 'block';
            }
        });

        try {
            // Import Firebase
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
            import { getDatabase, ref, onValue, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";
            import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";

            // Konfiguracja Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyBdVZRNj5-ni4rqhlYoN7jJKd4lwMWZG-Q",
                authDomain: "dziennik-snow.firebaseapp.com",
                databaseURL: "https://dziennik-snow-default-rtdb.europe-west1.firebasedatabase.app",
                projectId: "dziennik-snow",
                storageBucket: "dziennik-snow.appspot.com",
                messagingSenderId: "1041128277683",
                appId: "1:1041128277683:web:8bdfa137c75e0c3bced7dd"
            };

            // Inicjalizacja Firebase
            const app = initializeApp(firebaseConfig);
            console.log('Firebase zainicjalizowany.');
            const db = getDatabase(app);
            const auth = getAuth(app);

            // Elementy DOM
            const adminModal = document.getElementById('adminModal');
            const postModal = document.getElementById('postModal');
            const adminLink = document.getElementById('adminLink');
            const googleLogin = document.getElementById('googleLogin');
            const closes = document.querySelectorAll('.close');
            const networkStatus = document.getElementById('networkStatus');
            const postsList = document.getElementById('postsList');
            const archiveList = document.getElementById('archiveList');
            const dreamForm = document.getElementById('dreamForm');
            const postsLoading = document.getElementById('postsLoading');
            const archiveLoading = document.getElementById('archiveLoading');
            const closeForm = document.getElementById('closeForm');

            // Sprawdzenie elementów
            if (!adminModal || !postModal || !adminLink || !googleLogin || !closes || !networkStatus || !postsList || !archiveList || !dreamForm || !postsLoading || !archiveLoading || !closeForm) {
                console.error('Brak wymaganych elementów DOM:', {
                    adminModal, postModal, adminLink, googleLogin, closes, networkStatus,
                    postsList, archiveList, dreamForm, postsLoading, archiveLoading, closeForm
                });
                networkStatus.textContent = 'Błąd: Brak elementów strony.';
                networkStatus.style.display = 'block';
                throw new Error('Brak wymaganych elementów DOM');
            }

            // Inicjalny stan modalów
            adminModal.style.display = 'none';
            postModal.style.display = 'none';

            // Obsługa stanu autoryzacji
            onAuthStateChanged(auth, (user) => {
                if (user && user.email === 'lukasz13d@gmail.com') {
                    console.log('Zalogowano:', user.email);
                    adminModal.style.display = 'none';
                    postModal.style.display = 'block';
                } else {
                    console.log('Brak zalogowanego użytkownika lub nieprawidłowy email.');
                    adminModal.style.display = 'none';
                    postModal.style.display = 'none';
                }
            });

            // Status sieci
            function updateNetworkStatus() {
                if (navigator.onLine) {
                    networkStatus.classList.remove('offline');
                    networkStatus.style.display = 'none';
                } else {
                    networkStatus.classList.add('offline');
                    networkStatus.style.display = 'block';
                    networkStatus.textContent = 'Brak połączenia z internetem.';
                }
            }
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
            updateNetworkStatus();

            // Otwieranie modala logowania
            adminLink.addEventListener('click', (e) => {
                e.preventDefault();
                adminModal.style.display = 'block';
                postModal.style.display = 'none';
                console.log('Otwarto modal logowania.');
            });

            // Zamykanie modalów
            closes.forEach(close => {
                close.addEventListener('click', () => {
                    adminModal.style.display = 'none';
                    postModal.style.display = 'none';
                    dreamForm.reset();
                    console.log('Zamknięto modal.');
                });
            });

            closeForm.addEventListener('click', () => {
                postModal.style.display = 'none';
                dreamForm.reset();
                console.log('Zamknięto formularz.');
            });

            // Logowanie Google
            googleLogin.addEventListener('click', async () => {
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                try {
                    console.log('Próba logowania Google...');
                    const result = await signInWithPopup(auth, provider);
                    console.log('Logowanie udane:', result.user.email);
                    if (result.user.email === 'lukasz13d@gmail.com') {
                        adminModal.style.display = 'none';
                        postModal.style.display = 'block';
                        console.log('Otwarto formularz posta.');
                    } else {
                        alert('Dostęp tylko dla lukasz13d@gmail.com.');
                        await signOut(auth);
                        console.log('Wylogowano nieautoryzowanego użytkownika.');
                    }
                } catch (error) {
                    console.error('Błąd logowania:', error);
                    alert(`Błąd logowania: ${error.message} (Kod: ${error.code})`);
                    networkStatus.textContent = 'Błąd logowania. Sprawdź konsolę.';
                    networkStatus.style.display = 'block';
                }
            });

            // Ładowanie postów
            onValue(ref(db, 'posts'), (snapshot) => {
                postsList.innerHTML = '';
                postsLoading.classList.add('show');
                const posts = [];
                snapshot.forEach((child) => {
                    posts.push({ id: child.key, ...child.val() });
                });
                posts.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)).slice(0, 5);
                if (posts.length === 0) {
                    postsList.innerHTML = '<p class="no-posts">Brak postów do wyświetlenia.</p>';
                } else {
                    posts.forEach((post) => {
                        const postDiv = document.createElement('div');
                        postDiv.className = 'post';
                        postDiv.innerHTML = `
                            <div class="post-meta">Opublikowano: ${post.postDate} o ${post.postTime}</div>
                            <h3 class="post-title">${post.title}</h3>
                            <div class="post-data">Data snu: ${post.dreamDate}</div>
                            <div class="post-content">${post.content}</div>
                        `;
                        postsList.appendChild(postDiv);
                    });
                }
                postsLoading.classList.remove('show');
            }, (error) => {
                console.error('Błąd ładowania postów:', error);
                alert('Błąd ładowania postów: ' + error.message);
                postsLoading.classList.remove('show');
            });

            // Ładowanie archiwum
            onValue(ref(db, 'posts'), (snapshot) => {
                archiveList.innerHTML = '';
                archiveLoading.classList.add('show');
                const allPosts = [];
                snapshot.forEach((child) => {
                    allPosts.push({ id: child.key, ...child.val() });
                });
                const olderPosts = allPosts.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)).slice(5);
                olderPosts.forEach((post) => {
                    const archiveItem = document.createElement('div');
                    archiveItem.className = 'archive-item';
                    archiveItem.innerHTML = `
                        <span>${post.title} - Opublikowano ${post.postDate}</span>
                        <span class="expand-arrow">▶</span>
                    `;
                    archiveItem.addEventListener('click', () => {
                        onValue(ref(db, `posts/${post.id}`), (snapshot) => {
                            const fullPost = snapshot.val();
                            postsList.innerHTML = `
                                <div class="post">
                                    <div class="post-meta">Opublikowano: ${fullPost.postDate} o ${fullPost.postTime}</div>
                                    <h3 class="post-title">${fullPost.title}</h3>
                                    <div class="post-data">Data snu: ${fullPost.dreamDate}</div>
                                    <div class="post-content">${fullPost.content}</div>
                                </div>
                            `;
                        }, (error) => {
                            console.error('Błąd ładowania posta:', error);
                            alert('Błąd ładowania posta: ' + error.message);
                        });
                    });
                    archiveList.appendChild(archiveItem);
                });
                archiveLoading.classList.remove('show');
            }, (error) => {
                console.error('Błąd ładowania archiwum:', error);
                alert('Błąd ładowania archiwum: ' + error.message);
                archiveLoading.classList.remove('show');
            });

            // Dodawanie posta
            dreamForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const title = document.getElementById('postTitle').value.trim();
                const dreamDate = document.getElementById('dreamDate').value.trim();
                const content = document.getElementById('postContent').value.trim();
                if (!title || !dreamDate || !content) {
                    alert('Wypełnij wszystkie pola!');
                    return;
                }
                const now = new Date();
                const postDate = now.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const postTime = now.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
                try {
                    await push(ref(db, 'posts'), {
                        title,
                        dreamDate,
                        content,
                        postDate,
                        postTime,
                        createdAt: serverTimestamp()
                    });
                    alert('Sen zapisany pomyślnie!');
                    dreamForm.reset();
                    postModal.style.display = 'none';
                    console.log('Post zapisany.');
                } catch (error) {
                    console.error('Błąd zapisu posta:', error);
                    alert('Błąd zapisu posta: ' + error.message);
                    networkStatus.textContent = 'Błąd zapisu posta. Sprawdź konsolę.';
                    networkStatus.style.display = 'block';
                }
            });
        } catch (error) {
            console.error('Błąd inicjalizacji Firebase:', error);
            const networkStatus = document.getElementById('networkStatus');
            networkStatus.textContent = 'Krytyczny błąd Firebase. Sprawdź konsolę.';
            networkStatus.style.display = 'block';
        }
    </script>

    <!-- Skrypt dla rozwijania tekstu -->
    <script>
        const expandIntro = document.getElementById('expandIntro');
        const collapseIntro = document.getElementById('collapseIntro');
        const introFull = document.getElementById('introFull');

        if (expandIntro && collapseIntro && introFull) {
            expandIntro.addEventListener('click', (e) => {
                e.preventDefault();
                introFull.style.display = 'block';
                expandIntro.style.display = 'none';
                console.log('Rozwinięto wstęp.');
            });
            collapseIntro.addEventListener('click', (e) => {
                e.preventDefault();
                introFull.style.display = 'none';
                expandIntro.style.display = 'inline';
                console.log('Zwinięto wstęp.');
            });
        } else {
            console.error('Brak elementów intro:', { expandIntro, collapseIntro, introFull });
            const networkStatus = document.getElementById('networkStatus');
            networkStatus.textContent = 'Błąd: Brak elementów wstępu.';
            networkStatus.style.display = 'block';
        }
    </script>
</body>
</html>
