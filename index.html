<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Barastion Dreamscape – Dziennik Snów. Osobista podróż przez świat snów.">
    <meta name="keywords" content="dziennik snów, Barastion Dreamscape, interpretacja snów, świadome śnienie, zapisywanie snów">
    <meta name="author" content="Barastion">
    <meta property="og:title" content="Barastion Dreamscape – Dziennik Snów">
    <meta property="og:description" content="Osobista podróż przez świat snów. Zapisz i odkryj znaczenie swoich snów.">
    <meta property="og:image" content="Dreamscape_logo.jpg">
    <meta property="og:url" content="https://lukas-baran.github.io/Dziennik-Snow/">
    <meta property="og:type" content="website">
    <title>Barastion Dreamscape – Dziennik Snów</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="logo.png">
</head>
<body>
    <div class="container">
        <div class="content-wrapper">
            <header class="header">
                <div class="logo-frame">
                    <img src="Dreamscape_logo.jpg" alt="Barastion Dreamscape Logo" class="logo">
                </div>
                <h1>Barastion Dreamscape</h1>
                <p class="header-subtitle">– Dziennik Snów</p>
                <p class="header-subtitle">Osobista podróż do zakątków wyobraźni</p>
            </header>

            <main>
                <!-- Sekcja wprowadzająca -->
                <div class="section-container">
                    <section class="intro-container section-box">
                        <h2>Słowem wstępu</h2>
                        <p class="intro-text">
                            Z początkiem 2025 roku coś we mnie drgnęło, jakby głęboko ukryta część mojej świadomości nagle postanowiła przemówić. Sny, które wcześniej traktowałem jako przypadkowe, zaczęły układać się w zaskakującą narrację. Każda kolejna noc przynosiła obrazy pełne symboli, których znaczenie pozostawało dla mnie nieuchwytne, ale jednocześnie hipnotyzujące. Czułem, że te sny miały swój cel – że niosły ze sobą coś więcej niż tylko odzwierciedlenie codziennych myśli. Jakby otworzyły przede mną drzwi do nowego świata, w którym mogę eksplorować nieznane horyzonty i odkrywać zakamarki własnej świadomości.
                            <span id="expandIntro" class="intro-toggle">Rozwiń wstęp</span>
                        </p>
                        <div id="introFull" class="intro-full">
                            <p>
                                Wszystko zaczęło się od serii snów o psach. Przez niemal dziesięć nocy z rzędu śniły mi się psy – mnóstwo psów. Nie były wobec mnie agresywne. Czasem atakowały innych ludzi, czasem współpracowały z nimi, pomagając w różnych pracach, ale w każdym z tych snów pojawiał się jeden pies, który próbował wyprowadzić mnie z równowagi. Nie zbliżał się, ale nieustannie szczekał w moim kierunku, drażniąco, chwytał za ogon inne psy lub ludzi, generalnie uprzykrzając życie wszystkim wokół. Budziłem się z tych snów zirytowany jego obecnością, bo zakłócał każdy sen. W ostatnim śnie tej serii zobaczyłem tego psa słabego, niemal umierającego. Zrobiło mi się go żal. Pomogłem mu, choć nie wiem, jak to zrobiłem – leżał prawie martwy, a ja chciałem, by odzyskał siły. Udało się. Gdy tylko pies stanął na nogi, natychmiast wrócił do swojego dawnego zachowania – drażniącego szczekania i biegania wokół mnie, trzymając dystans, ale nie odpuszczając. Po tym śnie postanowiłem, że jeśli pojawi się znowu, nie będę mu pomagał. Byłem gotów pozbyć się go gołymi rękami. Od tamtej pory sny o psach ustały.
                            </p>
                            <p>
                                Po krótkiej przerwie rozpoczęła się nowa seria snów – tym razem o nieznanych miastach. Śniło mi się, że mieszkam w miejscach, których nie znam, chodzę ulicami, których nigdy nie widziałem. Ten motyw powtarzał się bardzo często, choć nie co noc, przez miesiąc, może nawet dwa. Nie rozpoznawałem żadnego z tych miast, żadnej ulicy, żadnego mieszkania, choć śniło mi się ich kilka. Zazwyczaj widziałem te miejsca nocą, rzadziej w porach popołudniowych. Nigdy wcześniej nie doświadczałem takich powtarzających się schematów w snach. Zastanawiałem się, czy to coś oznacza. W kwietniu 2025 roku dowiedziałem się, że czeka mnie przeprowadzka do nowego mieszkania – w tym samym mieście, ale w innym lokum. Nie wiem, czy sny o miastach były zapowiedzią tej zmiany, ale być może w przyszłości zrozumiem ich znaczenie.
                            </p>
                            <p>
                                Z czasem sny o miastach zaczęły ewoluować. Nie tylko śniły mi się nieznane miejsca, ale pojawił się nowy motyw – uczelnie. W tych obcych miastach zawsze przewijał się wątek edukacji: szkoły, uczelnie, ludzie, których nie znam. Każda placówka znajdowała się w innym miejscu, w innym mieście, którego nigdy nie widziałem. Nie pamiętam żadnych lekcji, ale pamiętam korytarze, podróże na zajęcia, wychodzenie z uczelni po zakończonych lekcjach. Gdy w drugiej połowie kwietnia 2025 roku zaczynam prowadzić ten dziennik, wątek uczelni wciąż jest obecny, choć motyw nieznanych miast powoli zanika. Teoretycznie każda uczelnia znajduje się w innym miejscu, bo nie rozpoznaję tych przestrzeni, ale coraz mniej skupiam się na samych miastach. Moja uwaga kieruje się na placówki, w których można zdobywać wiedzę – jakby to one stały się sercem moich snów.
                            </p>
                            <p>
                                Zainspirowany powtarzającymi się snami i schematami, jakich nigdy wcześniej nie znałem, postanowiłem zacząć zapisywać swoje sny. Nie wiem, czy mają jakieś znaczenie, ale ich powtarzalność sprawiła, że uznałem, że warto je notować. Być może kiedyś moje zapiski ujrzą światło dzienne, więc opisuję tylko to, co uważam za stosowne. Unikam imion i tematów zbyt osobistych czy delikatnych, dlatego niektóre fragmenty snów przemilczę. Chcę, by wszystkie osoby pojawiające się w moim dzienniku pozostały anonimowe.
                                <span id="collapseIntro" class="intro-toggle">Zwiń wstęp</span>
                            </p>
                        </div>
                    </section>
                </div>

                <!-- Sekcja postów -->
                <div class="section-container">
                    <section class="posts-container section-box">
                        <h2>Najnowsze wpisy</h2>
                        <div id="postsLoading" class="loading-spinner"></div>
                        <div id="postsList" class="posts-list"></div>
                    </section>
                </div>

                <!-- Sekcja archiwum -->
                <div class="section-container">
                    <section class="archive-container section-box">
                        <h2>Archiwum</h2>
                        <div id="archiveLoading" class="loading-spinner"></div>
                        <div id="archiveList" class="archive-list"></div>
                    </section>
                </div>
            </main>

            <footer class="footer">
                <p>© 2025 Barastion Dreamscape. Wszelkie prawa zastrzeżone.</p>
                <p class="footer-link"><span class="footer-text">Odwiedź</span> <a href="https://barastion.github.io/Barastion-Watchtower/" target="_blank">Barastion Watchtower</a></p>
                <p class="footer-link"><a href="#" id="adminLink">Napisz nowy post</a> <span id="logoutLink" class="logout-link">Wyloguj</span></p>
            </footer>
        </div>
    </div>

    <!-- Modal logowania -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h2>Zaloguj się</h2>
            <p>Zaloguj się, aby dodać lub edytować post. Dostęp tylko dla autora.</p>
            <button id="googleLogin" class="btn btn-google">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8c2.12 0 4.07.83 5.51 2.19l-2.09 2.09C14.64 6.49 13.38 6 12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.81 0 5.19-1.94 5.83-4.7h-5.83v-2.83h8.66c.07.41.11.84.11 1.28 0 4.41-3.59 8-8 8z"/>
                </svg>
                Zaloguj się przez Google
            </button>
            <p class="modal-note">Tylko autor jest uprawniony do dodawania nowych postów.</p>
        </div>
    </div>

    <!-- Modal dodawania/edycji posta -->
    <div id="postModal" class="modal">
        <div class="modal-content large-modal">
            <span class="close">×</span>
            <h2 id="postModalTitle">Dodaj nowy sen</h2>
            <form id="dreamForm" class="post-form">
                <div class="form-group">
                    <label for="postTitle">Tytuł snu</label>
                    <input type="text" id="postTitle" name="postTitle" placeholder="Np. Lot nad oceanem" required>
                </div>
                <div class="form-group">
                    <label for="dreamDate">Data snu</label>
                    <input type="text" id="dreamDate" name="dreamDate" placeholder="Np. noc z 12 na 13 marca 2025" required>
                </div>
                <div class="form-group">
                    <label for="postContent">Opis snu</label>
                    <textarea id="postContent" name="postContent" placeholder="Opisz swój sen szczegółowo..." required></textarea>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="btn btn-submit">Zapisz sen</button>
                    <button type="button" id="closeForm" class="btn btn-cancel">Zamknij</button>
                </div>
                <input type="hidden" id="postId" name="postId">
            </form>
        </div>
    </div>

    <!-- Status sieci -->
    <div id="networkStatus" class="network-status"></div>

    <!-- Skrypt dla rozwijania tekstu -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const expandIntro = document.getElementById('expandIntro');
            const collapseIntro = document.getElementById('collapseIntro');
            const introFull = document.getElementById('introFull');
            const networkStatus = document.getElementById('networkStatus');

            if (expandIntro && collapseIntro && introFull && networkStatus) {
                expandIntro.addEventListener('click', (e) => {
                    e.preventDefault();
                    introFull.style.display = 'block';
                    expandIntro.style.display = 'none';
                    console.log('Rozwinięto wstęp.');
                });
                collapseIntro.addEventListener('click', (e) => {
                    e.preventDefault();
                    introFull.style.display = 'none';
                    expandIntro.style.display = 'inline';
                    console.log('Zwinięto wstęp.');
                });
            } else {
                console.error('Brak elementów intro:', { expandIntro, collapseIntro, introFull, networkStatus });
                if (networkStatus) {
                    networkStatus.textContent = 'Błąd: Brak elementów wstępu.';
                    networkStatus.style.display = 'block';
                }
            }
        });
    </script>

    <!-- Skrypt Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBdVZRNj5-ni4rqhlYoN7jJKd4lwMWZG-Q",
            authDomain: "dziennik-snow.firebaseapp.com",
            databaseURL: "https://dziennik-snow-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "dziennik-snow",
            storageBucket: "dziennik-snow.appspot.com",
            messagingSenderId: "1041128277683",
            appId: "1:1041128277683:web:8bdfa137c75e0c3bced7dd"
        };

        try {
            const app = initializeApp(firebaseConfig);
            console.log('Firebase zainicjalizowany.');
            const db = getDatabase(app);
            const auth = getAuth(app);

            // Elementy DOM
            const adminModal = document.getElementById('adminModal');
            const postModal = document.getElementById('postModal');
            const adminLink = document.getElementById('adminLink');
            const logoutLink = document.getElementById('logoutLink');
            const googleLogin = document.getElementById('googleLogin');
            const closes = document.querySelectorAll('.close');
            const networkStatus = document.getElementById('networkStatus');
            const postsList = document.getElementById('postsList');
            const archiveList = document.getElementById('archiveList');
            const dreamForm = document.getElementById('dreamForm');
            const postsLoading = document.getElementById('postsLoading');
            const archiveLoading = document.getElementById('archiveLoading');
            const closeForm = document.getElementById('closeForm');
            const postModalTitle = document.getElementById('postModalTitle');
            const postIdInput = document.getElementById('postId');

            // Sprawdzenie elementów
            if (!adminModal || !postModal || !adminLink || !logoutLink || !googleLogin || !closes.length || !networkStatus || !postsList || !archiveList || !dreamForm || !postsLoading || !archiveLoading || !closeForm || !postModalTitle || !postIdInput) {
                console.error('Brak elementów DOM:', {
                    adminModal, postModal, adminLink, logoutLink, googleLogin, closes, networkStatus,
                    postsList, archiveList, dreamForm, postsLoading, archiveLoading, closeForm, postModalTitle, postIdInput
                });
                networkStatus.textContent = 'Błąd: Brak elementów strony.';
                networkStatus.style.display = 'block';
                throw new Error('Brak elementów DOM');
            }

            // Inicjalny stan modalów
            adminModal.style.display = 'none';
            postModal.style.display = 'none';
            logoutLink.style.display = 'none';

            // Status sieci
            const updateNetworkStatus = () => {
                if (navigator.onLine) {
                    networkStatus.classList.remove('offline');
                    networkStatus.style.display = 'none';
                } else {
                    networkStatus.classList.add('offline');
                    networkStatus.textContent = 'Brak połączenia z internetem.';
                    networkStatus.style.display = 'block';
                }
            };
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
            updateNetworkStatus();

            // Funkcja otwierania formularza posta
            const openPostModal = (postId = null, postData = null) => {
                postModalTitle.textContent = postId ? 'Edytuj sen' : 'Dodaj nowy sen';
                postIdInput.value = postId || '';
                document.getElementById('postTitle').value = postData?.title || '';
                document.getElementById('dreamDate').value = postData?.dreamDate || '';
                document.getElementById('postContent').value = postData?.content || '';
                postModal.style.display = 'block';
                adminModal.style.display = 'none';
                console.log(postId ? 'Otwarto formularz edycji.' : 'Otwarto formularz dodawania.');
            };

            // Otwieranie modala logowania lub formularza
            let isAuthenticated = false;
            adminLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (isAuthenticated) {
                    openPostModal();
                } else {
                    adminModal.style.display = 'block';
                    postModal.style.display = 'none';
                    console.log('Otwarto modal logowania.');
                }
            });

            // Wylogowanie
            logoutLink.addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    await signOut(auth);
                    console.log('Wylogowano pomyślnie.');
                    isAuthenticated = false;
                    adminLink.textContent = 'Napisz nowy post';
                    logoutLink.style.display = 'none';
                    adminModal.style.display = 'none';
                    postModal.style.display = 'none';
                    alert('Wylogowano pomyślnie.');
                } catch (error) {
                    console.error('Błąd wylogowania:', error);
                    alert(`Błąd wylogowania: ${error.message}`);
                    networkStatus.textContent = 'Błąd wylogowania. Sprawdź konsolę.';
                    networkStatus.style.display = 'block';
                }
            });

            // Zamykanie modalów
            closes.forEach(close => {
                close.addEventListener('click', () => {
                    adminModal.style.display = 'none';
                    postModal.style.display = 'none';
                    dreamForm.reset();
                    postIdInput.value = '';
                    postModalTitle.textContent = 'Dodaj nowy sen';
                    console.log('Zamknięto modal.');
                });
            });

            closeForm.addEventListener('click', () => {
                adminModal.style.display = 'none';
                postModal.style.display = 'none';
                dreamForm.reset();
                postIdInput.value = '';
                postModalTitle.textContent = 'Dodaj nowy sen';
                console.log('Zamknięto formularz.');
            });

            // Logowanie Google
            googleLogin.addEventListener('click', async () => {
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                try {
                    console.log('Próba logowania Google...');
                    const result = await signInWithPopup(auth, provider);
                    console.log('Logowanie udane:', result.user.email);
                    if (result.user.email === 'lukasz13d@gmail.com') {
                        isAuthenticated = true;
                        adminModal.style.display = 'none';
                        openPostModal();
                    } else {
                        alert('Dostęp tylko dla autora.');
                        await signOut(auth);
                        console.log('Wylogowano nieautoryzowanego użytkownika.');
                    }
                } catch (error) {
                    console.error('Błąd logowania:', error);
                    alert(`Błąd logowania: ${error.message} (Kod: ${error.code})`);
                    if (error.code === 'auth/popup-blocked') {
                        alert('Popup zablokowany. Włącz wyskakujące okna dla tej strony.');
                    }
                    networkStatus.textContent = 'Błąd logowania. Sprawdź konsolę.';
                    networkStatus.style.display = 'block';
                }
            });

            // Obsługa stanu autoryzacji
            onAuthStateChanged(auth, (user) => {
                if (user && user.email === 'lukasz13d@gmail.com') {
                    console.log('Zalogowano:', user.email);
                    isAuthenticated = true;
                    adminLink.textContent = 'Dodaj nowy post';
                    logoutLink.style.display = 'inline';
                } else {
                    console.log('Brak zalogowanego użytkownika lub nieprawidłowy email.');
                    isAuthenticated = false;
                    adminLink.textContent = 'Napisz nowy post';
                    logoutLink.style.display = 'none';
                    adminModal.style.display = 'none';
                    postModal.style.display = 'none';
                }
            });

            // Ładowanie postów
            onValue(ref(db, 'posts'), (snapshot) => {
                postsList.innerHTML = '';
                postsLoading.classList.add('show');
                const posts = [];
                snapshot.forEach((child) => {
                    posts.push({ id: child.key, ...child.val() });
                });
                posts.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)).slice(0, 5);
                if (posts.length === 0) {
                    postsList.innerHTML = '<p class="no-posts">Brak postów do wyświetlenia.</p>';
                } else {
                    posts.forEach((post) => {
                        const postDiv = document.createElement('div');
                        postDiv.className = 'post';
                        postDiv.innerHTML = `
                            <div class="post-meta">Opublikowano: ${post.postDate || 'Brak daty'} o ${post.postTime || 'Brak godziny'}</div>
                            <h3 class="post-title">${post.title || 'Bez tytułu'}</h3>
                            <div class="post-data">Data snu: ${post.dreamDate || 'Brak daty'}</div>
                            <div class="post-content">${post.content || 'Brak treści'}</div>
                            ${isAuthenticated ? `<button class="btn btn-edit" data-id="${post.id}">Edytuj</button>` : ''}
                        `;
                        postsList.appendChild(postDiv);
                    });
                    // Dodanie obsługi edycji
                    document.querySelectorAll('.btn-edit').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const postId = e.target.dataset.id;
                            onValue(ref(db, `posts/${postId}`), (snapshot) => {
                                const postData = snapshot.val();
                                openPostModal(postId, postData);
                            }, { onlyOnce: true });
                        });
                    });
                }
                postsLoading.classList.remove('show');
            }, (error) => {
                console.error('Błąd ładowania postów:', error);
                networkStatus.textContent = 'Błąd ładowania postów. Sprawdź konsolę.';
                networkStatus.style.display = 'block';
                postsLoading.classList.remove('show');
            });

            // Ładowanie archiwum
            onValue(ref(db, 'posts'), (snapshot) => {
                archiveList.innerHTML = '';
                archiveLoading.classList.add('show');
                const allPosts = [];
                snapshot.forEach((child) => {
                    allPosts.push({ id: child.key, ...child.val() });
                });
                const olderPosts = allPosts.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)).slice(5);
                if (olderPosts.length === 0) {
                    archiveList.innerHTML = '<p class="no-posts">Brak postów w archiwum.</p>';
                } else {
                    olderPosts.forEach((post) => {
                        const archiveItem = document.createElement('div');
                        archiveItem.className = 'archive-item';
                        archiveItem.innerHTML = `
                            <span>${post.title || 'Bez tytułu'} - Opublikowano ${post.postDate || 'Brak daty'}</span>
                            <span class="expand-arrow">▶</span>
                        `;
                        archiveItem.addEventListener('click', () => {
                            onValue(ref(db, `posts/${post.id}`), (snapshot) => {
                                const fullPost = snapshot.val();
                                postsList.innerHTML = `
                                    <div class="post">
                                        <div class="post-meta">Opublikowano: ${fullPost.postDate || 'Brak daty'} o ${fullPost.postTime || 'Brak godziny'}</div>
                                        <h3 class="post-title">${fullPost.title || 'Bez tytułu'}</h3>
                                        <div class="post-data">Data snu: ${fullPost.dreamDate || 'Brak daty'}</div>
                                        <div class="post-content">${fullPost.content || 'Brak treści'}</div>
                                        ${isAuthenticated ? `<button class="btn btn-edit" data-id="${post.id}">Edytuj</button>` : ''}
                                    </div>
                                `;
                                // Ponowne przypisanie obsługi edycji
                                if (isAuthenticated) {
                                    document.querySelector('.btn-edit').addEventListener('click', () => {
                                        openPostModal(post.id, fullPost);
                                    });
                                }
                            }, { onlyOnce: true });
                        });
                        archiveList.appendChild(archiveItem);
                    });
                }
                archiveLoading.classList.remove('show');
            }, (error) => {
                console.error('Błąd ładowania archiwum:', error);
                networkStatus.textContent = 'Błąd ładowania archiwum. Sprawdź konsolę.';
                networkStatus.style.display = 'block';
                archiveLoading.classList.remove('show');
            });

            // Dodawanie lub edycja posta
            dreamForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const postId = postIdInput.value;
                const title = document.getElementById('postTitle').value.trim();
                const dreamDate = document.getElementById('dreamDate').value.trim();
                const content = document.getElementById('postContent').value.trim();
                if (!title || !dreamDate || !content) {
                    alert('Wypełnij wszystkie pola!');
                    return;
                }
                const now = new Date();
                const postDate = now.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const postTime = now.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
                const postData = {
                    title,
                    dreamDate,
                    content,
                    postDate,
                    postTime,
                    createdAt: serverTimestamp()
                };
                try {
                    if (postId) {
                        await set(ref(db, `posts/${postId}`), postData);
                        alert('Sen zaktualizowany pomyślnie!');
                    } else {
                        await push(ref(db, 'posts'), postData);
                        alert('Sen zapisany pomyślnie!');
                    }
                    dreamForm.reset();
                    postIdInput.value = '';
                    postModalTitle.textContent = 'Dodaj nowy sen';
                    postModal.style.display = 'none';
                    console.log(postId ? 'Post zaktualizowany.' : 'Post zapisany.');
                } catch (error) {
                    console.error('Błąd zapisu posta:', error);
                    alert(`Błąd zapisu posta: ${error.message}`);
                    networkStatus.textContent = 'Błąd zapisu posta. Sprawdź konsolę.';
                    networkStatus.style.display = 'block';
                }
            });
        } catch (error) {
            console.error('Błąd inicjalizacji Firebase:', error);
            const networkStatus = document.getElementById('networkStatus');
            if (networkStatus) {
                networkStatus.textContent = 'Krytyczny błąd Firebase. Sprawdź konsolę.';
                networkStatus.style.display = 'block';
            }
        }
    </script>
</body>
</html>
